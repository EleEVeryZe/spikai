@if (isLoading()) {
  <div class="app-container loading-container">
    <mat-card class="quiz-card loading-card">
      <div class="spinner-wrapper">
        <mat-spinner diameter="50" color="primary"></mat-spinner>
        <p class="loading-text">Carregando Quiz...</p>
      </div>
    </mat-card>
  </div>
} @else {
<div class="app-container">
  <mat-card class="quiz-card">
    <mat-card-header class="quiz-header">
      <mat-card-title class="quiz-title"> Quizz </mat-card-title>
    </mat-card-header>

    <!-- Progress -->
    <mat-progress-bar mode="determinate" [value]="progressPercent()" class="quiz-progress-bar"></mat-progress-bar>
    <div class="progress-text">
      <span>Question {{ currentQuestionIndex() + 1 }} / {{ quizData().length }}</span>
      <span class="questions-left-text">({{ questionsLeft() }} questions left)</span>
    </div>

    <mat-card-content class="quiz-content">
      
      @if (currentQuestion()) {
        <div class="question-box">
          <p class="question-label">Complete the sentence:</p>
          <p class="question-sentence">"{{ currentQuestion().sentence.replace('___', '______') }}"</p>
        </div>

        <!-- Feedback -->
        @if (isCorrect() !== null) {
          <div class="feedback-box" [class.feedback-correct]="isCorrect()" [class.feedback-incorrect]="!isCorrect()">
            @if (isCorrect()) {
              <p class="feedback-text-bold feedback-text-green">
                <mat-icon class="icon-check">check_circle</mat-icon>
                Correct! Excellent job.
              </p>
            } @else {
              <p class="feedback-text-bold feedback-text-red">
                <mat-icon class="icon-error">cancel</mat-icon>
                Incorrect Answer.
              </p>
              <p *ngIf="!ehGrupoControle" class="feedback-text-italic">
                <span class="feedback-label">Tutoring:</span> {{ feedbackText() }}
              </p>
            }
          </div>
        }

        @if (geminiResponse() || isLoadingUserQuestion) {
        <mat-card class="gemini-response-card">
          <mat-card-content>
            <div class="response-header">
              <mat-icon class="response-icon">auto_fix_high</mat-icon>
              <span class="response-title">Tutor inteligente</span>
            </div>
            @if (geminiResponse()) {
              <p class="response-text">{{ geminiResponse() }}</p>
            }
            <mat-progress-spinner *ngIf="isLoadingUserQuestion" diameter="20" mode="indeterminate" color="accent" class="spinner"></mat-progress-spinner>
          </mat-card-content>
        </mat-card>
      }

        <!-- Options -->
        <mat-radio-group (change)="selectOption($event)" [value]="userSelection()" class="options-group">
          @for (option of currentQuestion().options; track option) {
            <mat-radio-button [value]="option" class="custom-radio">
              <span class="option-text">{{ option }}</span>
            </mat-radio-button>
          }
        </mat-radio-group>
      }

      <!-- Doubts & IA -->
      <div class="doubts-container" *ngIf="!ehGrupoControle && currentProgress() as progress">
        
        <mat-form-field class="doubts-input-field" appearance="outline">
          
          <mat-label>{{instrucaoIA}}</mat-label>
          <textarea
            matInput
            [ngModel]="progress.userDoubts"
            (ngModelChange)="updateUserDoubts($event)"
            rows="2"
            
          ></textarea>
        </mat-form-field>

        <button mat-mini-fab color="primary" (click)="askDeepSeekUserQuestion()" [disabled]="isGeminiLoading() || !progress.userDoubts" class="gemini-button">
          <mat-progress-spinner *ngIf="isLoadingUserQuestion" diameter="20" mode="indeterminate" color="accent" class="spinner"></mat-progress-spinner>
          <mat-icon class="gemini-icon" *ngIf="!isLoadingUserQuestion">send</mat-icon>
        </button>
      </div>
    </mat-card-content>

    <!-- Actions -->
    @if (currentQuestionIndex() !== quizData().length) {
    <mat-card-actions class="quiz-actions">
      <button mat-stroked-button (click)="previousQuestion()" [disabled]="currentQuestionIndex() === 0" class="action-button-prev">
        <mat-icon>arrow_back</mat-icon> Previous
      </button>
      <button
        mat-flat-button
        color="primary"
        (click)="nextQuestion()"
        [disabled]="userSelection() === null && currentQuestionIndex() < quizData().length"
        class="action-button-next"
      >
        @if (isLastQuestion()) {
          Finish Quiz <mat-icon>done_all</mat-icon>
        } @else {
          Next Question <mat-icon>arrow_forward</mat-icon>
        }
      </button>
    </mat-card-actions>
    }

    @if (currentQuestionIndex() === quizData().length) {
      <div class="quiz-complete-message">
        <p class="completion-title">ðŸŽ‰ Quiz Finalizado! ðŸŽ‰</p>
        <p class="completion-subtitle">
          VocÃª concluiu todas as {{ quizData().length }} perguntas. Revise o seu progresso!
        </p>
      </div>
    }
  </mat-card>
</div>
}